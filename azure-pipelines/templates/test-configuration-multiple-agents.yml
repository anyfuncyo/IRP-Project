# ui-test-shards.yml
parameters:
  - name: envSettings
    displayName: Environment preparation settings
    type: string
  - name: fastlaneSettings
    displayName: Fastlane lane to run
    type: string
  - name: jobSettings
    displayName: Pipeline job description
    type: string
  - name: indices
    type: object

jobs:
  - job: build
    displayName: ${{ parameters.jobSettings }}
    steps:
      - template: ${{ parameters.envSettings }}.yml
      - template: fastlane.yml
        parameters:
          lane: "${{ parameters.fastlaneSettings }}"
      - task: PublishPipelineArtifact@1
        displayName: "Publish build"
        condition: succeededOrFailed()
        inputs:
          artifactName: $(BUILD_ARTIFACT_NAME)
          targetPath: $(BUILD_OUTPUT_PATH)
  - ${{ each index in parameter.indices }}:
      - job: shard_${{ index }}
        dependsOn: [build]
        condition: succeeded()
        timeoutInMinutes: 15
        steps:
          - task: DowloadPipelineArtifacts@2
            displayName: Dowload UI test build
            inputs:
              buildType: current
              artifactName: $(BUILD_ARTIFACT_NAME)
              targetPath: $(BUILD_OUTPUT_PATH)
          - template: fastlane.yml
            displayName: Run parallel testing
            parameters:
              lane: "ui_test_shard shard_number: {{ index }}"
          - task: PublishPipelineArtifact@1
            displayName: Publish shard ${{ index }} test results
            condition: succeededOrFailed()
            inputs:
              artifactName: $(UI_TEST_RESULT_ARTIFACT_NAME)${{ index }}
              targetPath: $(TEST_OUTPUT_PATH)
